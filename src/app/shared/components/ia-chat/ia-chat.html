<!-- <div
  class="flex flex-col h-[600px] w-full max-w-md mx-auto border border-gray-200 rounded-2xl shadow-xl bg-white overflow-hidden"
>
  <div class="bg-indigo-600 p-4 text-white flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-indigo-400 flex items-center justify-center">
        <span class="material-icons text-xl">smart_toy</span>
      </div>
      <div>
        <h2 class="font-bold leading-none">Asistente Pro</h2>
        <p class="text-[10px] text-indigo-200 font-medium uppercase tracking-wider mt-1">
          AI Powered v20
        </p>
      </div>
    </div>
    <button
      (click)="closeIAChat()"
      class="p-1 hover:bg-white/20 rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-white/30"
      title="Cerrar chat"
    >
      <span class="material-icons text-xl">close</span>
    </button>
  </div>

  <div #scrollContainer class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
    @for (msg of messages(); track $index) {
      <div [class]="msg.sender === 'user' ? 'flex justify-end' : 'flex justify-start'">
        <div
          [ngClass]="{
            'bg-indigo-600 text-white rounded-br-none': msg.sender === 'user',
            'bg-white text-gray-800 border border-gray-100 rounded-bl-none': msg.sender === 'bot',
          }"
          class="max-w-[85%] p-3 rounded-2xl shadow-sm transition-all"
        >
          <p class="text-sm leading-relaxed">{{ msg.text }}</p>

          @if (msg.products && msg.products.length > 0) {
            <div class="mt-3 grid gap-2">
              @for (product of msg.products; track product.id) {
                <div
                  (click)="selectProduct(product)"
                  (keydown.enter)="selectProduct(product)"
                  role="button"
                  tabindex="0"
                  class="flex items-center gap-3 p-2 bg-slate-50 rounded-xl border border-gray-100 hover:border-indigo-400 hover:bg-indigo-50 transition-all cursor-pointer group shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-300"
                >
                  <div class="w-14 h-14 rounded-lg bg-gray-200 overflow-hidden flex-shrink-0">
                    <img
                      [src]="product.image"
                      class="w-full h-full object-cover group-hover:scale-110 transition-transform"
                      [alt]="product.title"
                      onerror="this.src = 'https://placehold.co/100x100?text=No+Image'"
                    />
                  </div>

                  <div class="min-w-0 flex-1">
                    <p class="text-xs font-bold text-gray-900 truncate">
                      {{ product.title }}
                    </p>
                    <p class="text-[10px] text-gray-500 line-clamp-1 italic">Click para detalles</p>
                    <p class="text-xs text-indigo-600 font-bold mt-0.5">
                      {{ product.price | currency }}
                    </p>
                  </div>
                  <span class="material-icons text-indigo-300 text-sm group-hover:text-indigo-600"
                    >info</span
                  >
                </div>
              }
            </div>
          }
        </div>
      </div>
    }

    @if (isTyping()) {
      <div class="flex justify-start">
        <div
          class="bg-white border border-gray-100 p-4 rounded-2xl rounded-bl-none shadow-sm flex gap-1.5"
        >
          <span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce"></span>
          <span
            class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce [animation-delay:0.2s]"
          ></span>
          <span
            class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce [animation-delay:0.4s]"
          ></span>
        </div>
      </div>
    }
  </div>

  @if (selectedProduct()) {
    <div
      class="px-4 py-2 bg-indigo-50 border-t border-indigo-100 flex justify-between items-center"
    >
      <div class="flex items-center gap-2 overflow-hidden">
        <span class="material-icons text-indigo-600 text-sm">psychology</span>
        <p class="text-[11px] text-indigo-800 truncate">
          Preguntando sobre: <strong>{{ selectedProduct().title }}</strong>
        </p>
      </div>
      <button
        (click)="clearSelection()"
        class="text-[11px] text-red-500 font-bold hover:underline ml-2"
      >
        SALIR
      </button>
    </div>
  }

  <div class="p-4 border-t border-gray-100 bg-white">
    <div
      class="flex items-center gap-2 bg-gray-50 border border-gray-200 p-2 rounded-2xl focus-within:border-indigo-400 transition-colors"
    >
      <input
        [(ngModel)]="userInput"
        (keyup.enter)="sendMessage()"
        type="text"
        [placeholder]="
          selectedProduct() ? 'Pregunta sobre este producto...' : 'Busca un producto...'
        "
        class="flex-1 bg-transparent border-none focus:ring-0 text-sm px-2 py-1 outline-none text-gray-700"
      />

      <button
        (click)="sendMessage()"
        [disabled]="!userInput().trim() || isTyping()"
        class="bg-indigo-600 text-white p-2.5 rounded-xl hover:bg-indigo-700 disabled:opacity-30 disabled:grayscale transition-all shadow-md shadow-indigo-200"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="w-5 h-5"
        >
          <path
            d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"
          />
        </svg>
      </button>
    </div>
  </div>
</div>
 -->

<div
  class="flex flex-col h-[600px] w-full max-w-md mx-auto border border-gray-200 rounded-2xl shadow-xl bg-white overflow-hidden"
>
  <div class="bg-indigo-600 p-4 text-white flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-indigo-400 flex items-center justify-center">
        <span class="material-icons text-xl">smart_toy</span>
      </div>
      <div>
        <h2 class="font-bold leading-none">Asistente Pro</h2>
        <p class="text-[10px] text-indigo-200 font-medium uppercase tracking-wider mt-1">
          AI Powered v20 (Backend Secure)
        </p>
      </div>
    </div>
    <button
      (click)="closeIAChat()"
      class="p-1 hover:bg-white/20 rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-white/30"
      title="Cerrar chat"
    >
      <span class="material-icons text-xl">close</span>
    </button>
  </div>

  <div #scrollContainer class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
    @for (msg of messages(); track $index) {
      <div [class]="msg.sender === 'user' ? 'flex justify-end' : 'flex justify-start'">
        <div
          [ngClass]="{
            'bg-indigo-600 text-white rounded-br-none': msg.sender === 'user',
            'bg-white text-gray-800 border border-gray-100 rounded-bl-none shadow-sm':
              msg.sender === 'bot',
          }"
          class="max-w-[85%] p-3 rounded-2xl transition-all"
        >
          <p class="text-sm leading-relaxed">{{ msg.text }}</p>

          @if (msg.products && msg.products.length > 0) {
            <div class="mt-3 grid gap-2">
              @for (product of msg.products; track product.id) {
                <div
                  class="flex items-center gap-3 p-2 bg-slate-50 rounded-xl border border-gray-100 hover:border-indigo-400 hover:bg-indigo-50 transition-all cursor-pointer group shadow-sm"
                >
                  <div class="w-14 h-14 rounded-lg bg-gray-200 overflow-hidden flex-shrink-0">
                    <img
                      [src]="product.image"
                      class="w-full h-full object-cover group-hover:scale-110 transition-transform"
                      [alt]="product.title"
                      onerror="this.src = 'https://placehold.co/100x100?text=No+Image'"
                    />
                  </div>
                  <div class="min-w-0 flex-1">
                    <p class="text-xs font-bold text-gray-900 truncate">{{ product.title }}</p>
                    <p class="text-xs text-indigo-600 font-bold mt-0.5">
                      {{ product.price | currency }}
                    </p>
                  </div>
                  <span class="material-icons text-indigo-300 text-sm">chevron_right</span>
                </div>
              }
            </div>
          }
        </div>
      </div>
    }

    @if (isTyping()) {
      <div class="flex justify-start">
        <div
          class="bg-white border border-gray-100 p-4 rounded-2xl rounded-bl-none shadow-sm flex gap-1.5"
        >
          <span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce"></span>
          <span
            class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce [animation-delay:0.2s]"
          ></span>
          <span
            class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce [animation-delay:0.4s]"
          ></span>
        </div>
      </div>
    }
  </div>

  @if (selectedProduct()) {
    <div
      class="px-4 py-2 bg-indigo-50 border-t border-indigo-100 flex justify-between items-center"
    >
      <div class="flex items-center gap-2 overflow-hidden">
        <span class="material-icons text-indigo-600 text-sm">inventory_2</span>
        <p class="text-[11px] text-indigo-800 truncate">
          Consultando sobre: <strong>{{ selectedProduct().title }}</strong>
        </p>
      </div>
      <!--  <button (click)="clearSelection()" class="text-[11px] text-red-500 font-bold hover:underline ml-2">
        QUITAR
      </button> -->
    </div>
  }

  <div class="p-4 border-t border-gray-100 bg-white">
    <div
      class="flex items-center gap-2 bg-gray-50 border border-gray-200 p-2 rounded-2xl focus-within:border-indigo-400 transition-colors"
    >
      <input
        [ngModel]="userInput()"
        (ngModelChange)="userInput.set($event)"
        (keyup.enter)="sendMessage()"
        type="text"
        [placeholder]="
          selectedProduct() ? 'Pregunta sobre este producto...' : 'Busca en el catÃ¡logo...'
        "
        class="flex-1 bg-transparent border-none focus:ring-0 text-sm px-2 py-1 outline-none text-gray-700"
      />

      <button
        (click)="sendMessage()"
        [disabled]="!userInput().trim() || isTyping()"
        class="bg-indigo-600 text-white p-2.5 rounded-xl hover:bg-indigo-700 disabled:opacity-30 disabled:grayscale transition-all shadow-md shadow-indigo-200"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="w-5 h-5"
        >
          <path
            d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"
          />
        </svg>
      </button>
    </div>
  </div>
</div>
